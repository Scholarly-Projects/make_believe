<style>
/* Scrollytelling footer styles */
.scrolly-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 999;
  background-color: rgba(17, 17, 17, 0.95);
  backdrop-filter: blur(10px);
  padding: 0.75rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.3s ease;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  gap: 1rem;
}

.scrolly-footer.light-mode {
  background-color: rgba(255, 255, 255, 0.95);
  border-top-color: rgba(0, 0, 0, 0.1);
}

/* Navigation arrows */
.chapter-nav {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.85);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
  transition: all 0.2s ease;
  text-decoration: none;
}

.chapter-nav:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: white;
  transform: scale(1.1);
}

.chapter-nav:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.scrolly-footer.light-mode .chapter-nav {
  color: rgba(0, 0, 0, 0.75);
}

.scrolly-footer.light-mode .chapter-nav:hover {
  background-color: rgba(0, 0, 0, 0.05);
  color: #000;
}

/* Citation wrapper */
.scrolly-citation-wrapper {
  display: flex;
  flex: 1;
  justify-content: center;
  align-items: center;
  min-width: 0;
  max-width: 100%;
}

/* Image citation — centered, full wrapper width */
.scrolly-image-citation-footer {
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.85);
  opacity: 0;
  transform: translateY(10px);
  transition: opacity {{ site.data.theme.scrollytelling.fade-duration | default: 0.3 }}s ease,
              transform {{ site.data.theme.scrollytelling.fade-duration | default: 0.3 }}s ease;
  min-width: 0;
  max-width: 70%;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  box-sizing: border-box;
}

.scrolly-image-citation-footer.visible {
  opacity: 1;
  transform: translateY(0);
}

.scrolly-footer.light-mode .scrolly-image-citation-footer {
  color: rgba(0, 0, 0, 0.75);
}

/* Citation content */
.scrolly-citation-content {
  width: 100%;
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  line-height: 1.4;
  max-width: 100%;
  text-align: center;
}

/* Citation label */
.scrolly-citation-label {
  font-size: 0.75em;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.35rem;
  display: block;
  color: rgba(255, 255, 255, 0.6);
  width: 100%;
  text-align: center;
}

.scrolly-footer.light-mode .scrolly-citation-label {
  color: rgba(0, 0, 0, 0.5);
}

/* "View Item" link styling */
.view-item-link {
  display: inline-block;
  margin-top: 0.25rem;
  font-size: 0.85em;
  color: var(--bs-link-color) !important;
  text-decoration: underline !important;
  opacity: 0.9;
  transition: opacity 0.2s ease;
}

.view-item-link:hover {
  opacity: 1;
  text-decoration: underline !important;
}

/* ── Mobile title-only citation ──────────────────────────────────────────
   Wraps freely so long titles never get clipped. Footer height grows to
   fit; arrows are centered vertically via align-self.                   */
.scrolly-mobile-citation {
  display: none;                  /* hidden on desktop                   */
  font-size: 0.78em;
  color: rgba(255, 255, 255, 0.85);
  text-align: center;
  line-height: 1.4;
  min-width: 0;
}

.scrolly-footer.light-mode .scrolly-mobile-citation {
  color: rgba(0, 0, 0, 0.75);
}

.scrolly-mobile-citation .mobile-image-title {
  font-style: italic;
}

/* ── In-text footnote superscript links ─────────────────────────────── */
.footnote-ref .footnote-link {
  color: inherit;
  text-decoration: none;
  border-bottom: 1px dotted currentColor;
  padding-bottom: 1px;
  transition: color 0.15s ease, border-bottom-color 0.15s ease;
}

.footnote-ref .footnote-link:hover {
  color: var(--bs-link-color, #6ea8fe);
  border-bottom-style: solid;
}

/* ── Responsive ──────────────────────────────────────────────────────── */
@media (max-width: 992px) {
  .scrolly-footer {
    padding: 0.4rem 1.25rem !important;
    min-height: unset !important;
    align-items: stretch !important;  /* let children control their own vertical alignment */
    flex-direction: row !important;
    flex-wrap: nowrap;
  }

  /* Arrows stay vertically centred regardless of how tall the citation grows */
  .chapter-nav {
    width: 36px !important;
    height: auto !important;
    font-size: 1.25rem !important;
    align-self: center !important;
    flex-shrink: 0;
  }

  /* Hide the full desktop citation; show the compact mobile version */
  .scrolly-citation-wrapper {
    display: none !important;
  }

  /* Mobile citation: wraps freely so long titles never get clipped */
  .scrolly-mobile-citation {
    display: flex !important;
    flex: 1 1 0;
    min-width: 0;
    padding: 0.35rem 0.5rem;
    align-items: center;
    justify-content: center;
    white-space: normal;
    overflow: visible;
    word-break: break-word;
  }
}
</style>

<footer class="scrolly-footer" id="scrolly-footer">
  <!-- Previous Chapter Arrow -->
  <a href="#" class="chapter-nav prev" id="prev-chapter" aria-label="Previous chapter" disabled>
    ❮
  </a>

  <!-- Desktop: full citation centered -->
  <div class="scrolly-citation-wrapper">
    <div class="scrolly-image-citation-footer" id="scrolly-image-citation-footer">
      <span class="scrolly-citation-label">Image</span>
      <div class="scrolly-citation-content">
        <span id="scrolly-image-citation-content"></span>
        <a href="#" class="view-item-link" id="scrolly-image-view-link" style="display:none">, View Item</a>
      </div>
    </div>
  </div>

  <!-- Mobile: title + View Item link only -->
  <div class="scrolly-mobile-citation" id="scrolly-mobile-citation">
    <span class="mobile-image-title" id="scrolly-mobile-image-title"></span><a href="#" class="view-item-link" id="scrolly-mobile-view-link" style="display:none">&thinsp;&mdash;&thinsp;View Item</a>
  </div>

  <!-- Next Chapter Arrow -->
  <a href="#" class="chapter-nav next" id="next-chapter" aria-label="Next chapter" disabled>
    ❯
  </a>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var prevChapterLink = document.getElementById('prev-chapter');
  var nextChapterLink = document.getElementById('next-chapter');

  function normalize(url) {
    return (url || '').replace(/\/$/, '').replace(/\.html$/, '');
  }

  // ── 1. Main site navigation sequence ─────────────────────────────────
  var allNavItems = [
    { url: '{{ "/" | relative_url }}', title: 'Home' },
    {% assign sorted_essays = site.essay | sort: 'order' %}
    {% for item in sorted_essays %}
    { url: '{{ item.url | relative_url }}', title: {{ item.title | jsonify }} },
    {% endfor %}
    {% for nav in site.data.config-nav %}
    {% unless nav.stub == "/" or nav.stub contains "/essay/" %}
    { url: '{{ nav.stub | relative_url }}', title: {{ nav.display_name | jsonify }} },
    {% endunless %}
    {% endfor %}
  ].filter(function(item) { return item.url; });

  // ── 2. Item-level page sequence ───────────────────────────────────────
  var allItemPages = [
    {% for item in site.data[site.metadata] %}
    { url: '{{ site.baseurl }}/items/{{ item.objectid }}.html', title: {{ item.title | jsonify }} },
    {% endfor %}
  ].filter(function(item) { return item.url; });

  var currentUrl = normalize(window.location.pathname);

  var itemBasePattern = normalize('{{ site.baseurl }}/items/');
  var onItemPage = currentUrl.startsWith(itemBasePattern) &&
                   currentUrl.length > itemBasePattern.length;

  // ── 3. Wire footer arrows to the main nav sequence ────────────────────
  var mainIndex = allNavItems.findIndex(function(item) {
    return normalize(item.url) === currentUrl;
  });

  console.log('[footer-scrollytelling] currentUrl:', currentUrl);
  console.log('[footer-scrollytelling] mainIndex:', mainIndex, '/', allNavItems.length - 1);

  if (prevChapterLink) {
    if (mainIndex > 0) {
      var prevItem = allNavItems[mainIndex - 1];
      prevChapterLink.href                = prevItem.url;
      prevChapterLink.removeAttribute('disabled');
      prevChapterLink.style.opacity       = '1';
      prevChapterLink.style.pointerEvents = '';
      prevChapterLink.title               = 'Previous: ' + prevItem.title;
    } else {
      prevChapterLink.href                = '#';
      prevChapterLink.setAttribute('disabled', 'disabled');
      prevChapterLink.style.opacity       = '0.3';
      prevChapterLink.style.pointerEvents = 'none';
      prevChapterLink.title               = 'No previous';
    }
  }

  if (nextChapterLink) {
    if (mainIndex >= 0 && mainIndex < allNavItems.length - 1) {
      var nextItem = allNavItems[mainIndex + 1];
      nextChapterLink.href                = nextItem.url;
      nextChapterLink.removeAttribute('disabled');
      nextChapterLink.style.opacity       = '1';
      nextChapterLink.style.pointerEvents = '';
      nextChapterLink.title               = 'Next: ' + nextItem.title;
    } else if (mainIndex === allNavItems.length - 1) {
      nextChapterLink.href                = allNavItems[0].url;
      nextChapterLink.removeAttribute('disabled');
      nextChapterLink.style.opacity       = '1';
      nextChapterLink.style.pointerEvents = '';
      nextChapterLink.title               = 'Back to: ' + allNavItems[0].title;
    } else {
      nextChapterLink.href                = allNavItems[0].url;
      nextChapterLink.removeAttribute('disabled');
      nextChapterLink.style.opacity       = '1';
      nextChapterLink.style.pointerEvents = '';
      nextChapterLink.title               = 'Back to: ' + allNavItems[0].title;
    }
  }

  // ── 4. Keyboard navigation ────────────────────────────────────────────
  var keyPrevUrl = null;
  var keyNextUrl = null;

  if (onItemPage) {
    var itemIndex = allItemPages.findIndex(function(item) {
      return normalize(item.url) === currentUrl;
    });

    keyPrevUrl = (itemIndex > 0)
      ? allItemPages[itemIndex - 1].url
      : allItemPages[allItemPages.length - 1].url;

    keyNextUrl = (itemIndex >= 0 && itemIndex < allItemPages.length - 1)
      ? allItemPages[itemIndex + 1].url
      : allItemPages[0].url;
  } else {
    keyPrevUrl = (prevChapterLink && !prevChapterLink.hasAttribute('disabled'))
      ? prevChapterLink.getAttribute('href') : null;
    keyNextUrl = nextChapterLink
      ? nextChapterLink.getAttribute('href') : null;
  }

  document.addEventListener('keydown', function(e) {
    var tag = document.activeElement ? document.activeElement.tagName : '';
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

    if (e.key === 'ArrowLeft' || e.key === 'Left') {
      if (keyPrevUrl && keyPrevUrl !== '#') window.location.href = keyPrevUrl;
    } else if (e.key === 'ArrowRight' || e.key === 'Right') {
      if (keyNextUrl && keyNextUrl !== '#') window.location.href = keyNextUrl;
    }
  });
});
</script>