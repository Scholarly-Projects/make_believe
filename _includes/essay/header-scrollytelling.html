<style>
/* Scrollytelling header styles */
.scrolly-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background-color: rgba(17, 17, 17, 0.95);
  backdrop-filter: blur(10px);
  /* env(safe-area-inset-top) adds clearance for iOS notch/dynamic island.
     Browsers without safe-area support treat it as 0, so this is safe
     everywhere. The header background extends into the notch area and
     content is pushed below it.                                          */
  padding: calc(0.65rem + 20px + env(safe-area-inset-top, 0px)) 1.5rem 0.85rem;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  justify-content: space-between;
  gap: 1rem;
  transition: background-color 0.3s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.scrolly-site-info {
  text-align: center;
  flex: 1 1 auto;
  margin: 10px 0 0 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.2rem;
}

.scrolly-site-title {
  font-size: 1.1em;
  font-weight: bold;
  color: rgba(255, 255, 255, 0.95);
  margin: 0;
  line-height: 1.2;
  cursor: pointer;
  transition: color 0.2s ease;
}

.scrolly-site-title:hover {
  color: rgba(255, 255, 255, 1);
}

.scrolly-site-subtitle {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.7);
  margin: 0;
  line-height: 1.3;
}

.scrolly-chapter-title {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.6);
  margin: 0;
  font-weight: normal;
  line-height: 1.3;
  transition: opacity 0.3s ease;
}

/* ── Right column: hamburger stacked above the theme toggle row ─────── */
/* align-self: stretch makes the column as tall as the centre title block.
   justify-content: space-between pushes the hamburger to the top and the
   toggle row to the bottom, landing it level with the chapter-title line. */
.scrolly-header-right {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  align-self: stretch;
  flex-shrink: 0;
}

/* ── Theme toggle row: sun icon + pill toggle ───────────────────────── */
.theme-toggle-row {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

/* Sun icon — stroke-based, no fill */
.sun-icon {
  width: 13px;
  height: 13px;
  flex-shrink: 0;
  fill: none;
  stroke: rgba(255, 255, 255, 0.75);
  stroke-width: 2;
  stroke-linecap: round;
  opacity: 0.7;
  transition: stroke 0.25s ease, opacity 0.25s ease;
}

/* Pill toggle track */
.theme-toggle {
  position: relative;
  width: 34px;
  height: 18px;
  background-color: rgba(255, 255, 255, 0.85);
  border-radius: 9px;
  cursor: pointer;
  border: none;
  padding: 0;
  flex-shrink: 0;
  opacity: 0.65;
  transition: background-color 0.25s ease, opacity 0.25s ease;
}

.theme-toggle:hover {
  opacity: 1;
}

/* Sliding circle */
.theme-toggle::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 12px;
  height: 12px;
  background-color: #111111;
  border-radius: 50%;
  transition: transform 0.25s ease;
}

/* Light mode: track darkens, circle slides right and turns white */
body.light-mode .theme-toggle {
  background-color: rgba(0, 0, 0, 0.22);
  opacity: 0.7;
}

body.light-mode .theme-toggle:hover {
  opacity: 1;
}

body.light-mode .theme-toggle::after {
  background-color: #ffffff;
  transform: translateX(16px);
}

/* Hamburger menu */
.hamburger-menu {
  position: relative;
  width: 24px;
  height: 20px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  flex-shrink: 0;
}

.hamburger-line {
  width: 100%;
  height: 2px;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 2px;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* Off-canvas menus */
.offcanvas-menu {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 300px;
  background-color: rgba(17, 17, 17, 0.98);
  backdrop-filter: blur(10px);
  padding: 1.5rem;
  overflow-y: auto;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 1002;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.offcanvas-menu.active {
  display: block;
  transform: translateX(0);
}

.offcanvas-menu.right {
  right: 0;
  left: auto;
  transform: translateX(100%);
  border-right: none;
  border-left: 1px solid rgba(255, 255, 255, 0.1);
}

.offcanvas-menu.right.active {
  transform: translateX(0);
}

.offcanvas-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.8);
  font-size: 1.5em;
  cursor: pointer;
  padding: 0.25rem;
  z-index: 1003;
}

.offcanvas-title {
  font-size: 1.3em;
  color: rgba(255, 255, 255, 0.95);
  margin-bottom: 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.offcanvas-menu-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.offcanvas-menu-item {
  margin-bottom: 0.5rem;
}

.offcanvas-menu-link {
  display: block;
  padding: 0.75rem 1rem;
  color: rgba(255, 255, 255, 0.85);
  text-decoration: none;
  border-radius: 4px;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.offcanvas-menu-link:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: white;
}

.offcanvas-menu-link.active {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
  font-weight: bold;
}

/* Backdrop for off-canvas */
.offcanvas-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1001;
}

.offcanvas-backdrop.active {
  display: block;
  opacity: 1;
}

/* ── Responsive ─────────────────────────────────────────────────────── */
@media (max-width: 768px) {
  .scrolly-header {
    padding: 0.55rem 1rem 0.7rem;
  }

  .scrolly-site-info {
    margin-top: 8px;
  }

  .scrolly-site-title {
    font-size: 0.95em;
  }

  .scrolly-site-subtitle,
  .scrolly-chapter-title {
    font-size: 0.72em;
  }

  .theme-toggle {
    width: 30px;
    height: 16px;
  }

  .theme-toggle::after {
    width: 10px;
    height: 10px;
  }

  body.light-mode .theme-toggle::after {
    transform: translateX(14px);
  }

  .sun-icon {
    width: 11px;
    height: 11px;
  }
}
</style>

<!-- Chapters Offcanvas Menu (Left) -->
<div class="offcanvas-menu" id="offcanvas-chapters">
  <button class="offcanvas-close" id="close-chapters" aria-label="Close chapters menu">&times;</button>
  <h3 class="offcanvas-title">Chapters</h3>
  <ul class="offcanvas-menu-list">
    {% assign essays = site.essay | sort: 'order' %}
    {% for item in essays %}
    <li class="offcanvas-menu-item">
      <a href="{{ item.url | relative_url }}" class="offcanvas-menu-link {% if item.url == page.url %}active{% endif %}">
        {% if item.order %}{{ item.order }}. {% endif %}{{ item.title }}
      </a>
    </li>
    {% endfor %}
  </ul>
</div>

<!-- Site Navigation Offcanvas Menu (Right) -->
<div class="offcanvas-menu right" id="offcanvas-site">
  <button class="offcanvas-close" id="close-site" aria-label="Close site navigation menu">&times;</button>
  <h3 class="offcanvas-title">Site Navigation</h3>
  <ul class="offcanvas-menu-list">
    {% for nav in site.data.config-nav %}
    <li class="offcanvas-menu-item">
      <a href="{{ nav.stub | relative_url }}" class="offcanvas-menu-link {% if nav.stub == page.url %}active{% endif %}">
        {{ nav.display_name }}
      </a>
    </li>
    {% endfor %}
  </ul>
</div>

<!-- Backdrop -->
<div class="offcanvas-backdrop" id="offcanvas-backdrop"></div>

<!-- Header: left hamburger | centre title block | right column -->
<header class="scrolly-header" id="scrolly-header">

  <!-- Left: chapters menu trigger -->
  <div class="hamburger-menu" id="hamburger-chapters" role="button" tabindex="0" aria-label="Open chapters menu">
    <div class="hamburger-line"></div>
    <div class="hamburger-line"></div>
    <div class="hamburger-line"></div>
  </div>

  <!-- Centre: site identity -->
  <div class="scrolly-site-info">
    <h1 class="scrolly-site-title" id="scrolly-site-title">{{ site.title }}</h1>
    <div class="scrolly-site-subtitle">{{ site.tagline }} | {{ site.author }}</div>
    <div class="scrolly-chapter-title" id="scrolly-chapter-display">
      {% if page.chapter %}Chapter {{ page.order }}: {{ page.chapter }}
      {% else %}{{ page.title }}{% endif %}
    </div>
  </div>

  <!-- Right: site-nav hamburger above, then sun + toggle below -->
  <div class="scrolly-header-right">

    <div class="hamburger-menu" id="hamburger-site" role="button" tabindex="0" aria-label="Open site navigation menu">
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
    </div>

    <div class="theme-toggle-row">
      <!-- Sun: signals "this controls brightness" -->
      <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="4"/>
        <line x1="12" y1="2"  x2="12" y2="5"/>
        <line x1="12" y1="19" x2="12" y2="22"/>
        <line x1="4.22"  y1="4.22"  x2="6.34"  y2="6.34"/>
        <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
        <line x1="2"  y1="12" x2="5"  y2="12"/>
        <line x1="19" y1="12" x2="22" y2="12"/>
        <line x1="4.22"  y1="19.78" x2="6.34"  y2="17.66"/>
        <line x1="17.66" y1="6.34"  x2="19.78" y2="4.22"/>
      </svg>

      <!-- Pill toggle — CSS drives the circle position via body.light-mode -->
      <button
        class="theme-toggle"
        id="theme-toggle"
        aria-label="Toggle light/dark mode"
        title="Toggle light/dark mode"
        role="switch"
        aria-checked="false"
      ></button>
    </div>

  </div>

</header>

<script>
// ── Enforce dark mode as the baseline ────────────────────────────────
// Runs immediately (before first paint) AND again on DOMContentLoaded as
// a backstop, because document.body may not exist yet if this script is
// evaluated inside <head>. documentElement (<html>) is always available
// and is used as the immediate anchor; body is patched once it exists.
(function () {
  var isLight = false;
  try {
    isLight = localStorage.getItem('scrolly-theme') === 'light';
    if (!isLight) localStorage.setItem('scrolly-theme', 'dark');
  } catch (e) {}

  // Apply immediately to <html> so there is zero flash regardless of
  // where in the document this script tag appears.
  var root = document.documentElement;
  if (isLight) {
    root.classList.add('light-mode');
  } else {
    root.classList.remove('light-mode');
  }

  // Patch <body> the moment the DOM is ready.
  document.addEventListener('DOMContentLoaded', function () {
    var light = localStorage.getItem('scrolly-theme') === 'light';
    if (light) {
      document.body.classList.add('light-mode');
    } else {
      document.body.classList.remove('light-mode');
    }
    // Clean <html> now that <body> is the authoritative target.
    document.documentElement.classList.remove('light-mode');
  }, { once: true });
}());

document.addEventListener('DOMContentLoaded', function () {
  'use strict';

  var chaptersMenu      = document.getElementById('offcanvas-chapters');
  var siteMenu          = document.getElementById('offcanvas-site');
  var backdrop          = document.getElementById('offcanvas-backdrop');
  var hamburgerChapters = document.getElementById('hamburger-chapters');
  var hamburgerSite     = document.getElementById('hamburger-site');
  var closeChapters     = document.getElementById('close-chapters');
  var closeSite         = document.getElementById('close-site');
  var siteTitle         = document.getElementById('scrolly-site-title');
  var themeToggle       = document.getElementById('theme-toggle');
  var menuLinks         = document.querySelectorAll('.offcanvas-menu-link');

  closeAllMenus();

  // Sync ARIA with theme already applied at load time
  if (themeToggle) {
    themeToggle.setAttribute('aria-checked',
      document.body.classList.contains('light-mode') ? 'true' : 'false');
  }

  // ── Hamburger / off-canvas ─────────────────────────────────────────
  if (hamburgerChapters) {
    hamburgerChapters.addEventListener('click', function (e) { e.stopPropagation(); openMenu('chapters'); });
    hamburgerChapters.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMenu('chapters'); }
    });
  }

  if (hamburgerSite) {
    hamburgerSite.addEventListener('click', function (e) { e.stopPropagation(); openMenu('site'); });
    hamburgerSite.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMenu('site'); }
    });
  }

  if (closeChapters) { closeChapters.addEventListener('click', function (e) { e.stopPropagation(); closeAllMenus(); }); }
  if (closeSite)     { closeSite.addEventListener('click',     function (e) { e.stopPropagation(); closeAllMenus(); }); }
  if (backdrop)      { backdrop.addEventListener('click', closeAllMenus); }

  menuLinks.forEach(function (link) { link.addEventListener('click', closeAllMenus); });

  document.addEventListener('keydown', function (e) { if (e.key === 'Escape') { closeAllMenus(); } });

  document.addEventListener('click', function (e) {
    var chaptersOpen = chaptersMenu && chaptersMenu.classList.contains('active');
    var siteOpen     = siteMenu     && siteMenu.classList.contains('active');
    if (chaptersOpen && !chaptersMenu.contains(e.target) && hamburgerChapters && !hamburgerChapters.contains(e.target)) { closeAllMenus(); }
    if (siteOpen     && !siteMenu.contains(e.target)     && hamburgerSite     && !hamburgerSite.contains(e.target))     { closeAllMenus(); }
  });

  if (siteTitle) {
    siteTitle.addEventListener('click', function () { window.location.href = '{{ "/" | relative_url }}'; });
  }

  // ── Theme toggle ──────────────────────────────────────────────────
  if (themeToggle) {
    themeToggle.addEventListener('click', function () {
      var isLight = document.body.classList.toggle('light-mode');
      // Keep <html> clean — body.light-mode is the sole authority.
      document.documentElement.classList.remove('light-mode');
      themeToggle.setAttribute('aria-checked', isLight ? 'true' : 'false');

      try { localStorage.setItem('scrolly-theme', isLight ? 'light' : 'dark'); } catch (e) {}

      // Notify ScrollyTelling so the image panel and citation column update
      if (window.scrolly && typeof window.scrolly.updateTheme === 'function') {
        window.scrolly.updateTheme();
      }
    });
  }

  // ── Helpers ───────────────────────────────────────────────────────
  function openMenu(menuName) {
    closeAllMenus();
    if (menuName === 'chapters' && chaptersMenu) { chaptersMenu.classList.add('active'); }
    else if (menuName === 'site' && siteMenu)    { siteMenu.classList.add('active'); }
    if (backdrop) { backdrop.classList.add('active'); }
    document.body.style.overflow = 'hidden';
  }

  function closeAllMenus() {
    if (chaptersMenu) { chaptersMenu.classList.remove('active'); }
    if (siteMenu)     { siteMenu.classList.remove('active'); }
    if (backdrop)     { backdrop.classList.remove('active'); }
    document.body.style.overflow = '';
  }
});

/**
 * updateChapterDisplay — called by ScrollyTelling on chapter change.
 */
window.updateChapterDisplay = function (data) {
  var el = document.getElementById('scrolly-chapter-display');
  if (!el || !data) return;

  var label = (data.chapter && data.chapter.trim()) ? data.chapter.trim() : (data.title || '');
  var text  = data.order ? 'Chapter ' + data.order + ': ' + label : label;

  if (el.textContent !== text) {
    el.style.transition = 'opacity 0.2s ease';
    el.style.opacity = '0';
    setTimeout(function () {
      el.textContent = text;
      el.style.opacity = '1';
    }, 200);
  }
};

// ── Measure actual header height and expose as CSS variable ───────────
// This lets scrolly.scss use --scrolly-header-h for the sticky image
// column offset, giving pixel-perfect clearance on every device including
// iOS with notch/dynamic island (whose safe-area adds to the header height
// via the env() in the padding rule above).
(function () {
  function setHeaderHeight() {
    var header = document.getElementById('scrolly-header');
    if (!header) return;
    var h = header.getBoundingClientRect().height;
    document.documentElement.style.setProperty('--scrolly-header-h', h + 'px');
  }

  // Set once on load, then again after fonts/images settle
  document.addEventListener('DOMContentLoaded', setHeaderHeight);
  window.addEventListener('load', setHeaderHeight);
  // Re-measure on resize (orientation change, font scale change, etc.)
  window.addEventListener('resize', setHeaderHeight, { passive: true });
}());
</script>